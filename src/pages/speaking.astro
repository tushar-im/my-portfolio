---
/**
 * Speaking Page
 * 
 * Lists all speaking engagements including conferences, meetups, podcasts, workshops,
 * and webinars. Organizes talks by year in reverse chronological order, with each year
 * displaying its talks sorted by date (most recent first).
 * 
 * Features:
 * - Queries all speaking entries from content collection
 * - Sorts by date (descending - most recent first)
 * - Groups talks by year for easy navigation
 * - Displays statistics (total talks, conference count)
 * - Color-coded badges by talk type
 * - Links to slides and video recordings when available
 * - Empty state handling
 * 
 * Talk Types:
 * - conference: Conference presentations
 * - meetup: Local meetup talks
 * - podcast: Podcast appearances
 * - workshop: Hands-on workshops
 * - webinar: Online webinars
 * 
 * Route: /speaking
 * 
 * @page
 */

import BaseLayout from '../layouts/BaseLayout.astro';
import SEO from '../components/SEO.astro';
import TalkCard from '../components/TalkCard.astro';
import PageStats from '../components/PageStats.astro';
import { getCollection } from 'astro:content';
import { pagesConfig } from '../pages.config';

/**
 * Queries all speaking entries from the content collection
 */
const allTalks = await getCollection('speaking');

/**
 * Sorts talks by date in descending order (most recent first)
 * 
 * Ensures the latest speaking engagements appear at the top of each year section.
 */
const sortedTalks = allTalks.sort((a, b) => {
  return b.data.date.getTime() - a.data.date.getTime();
});

/**
 * Groups talks by year for organized display
 * 
 * Creates a record object where keys are years and values are arrays of talks
 * from that year. This enables year-based section headers in the UI.
 * 
 * @returns Record with year as key and array of talks as value
 */
const talksByYear = sortedTalks.reduce((acc, talk) => {
  const year = talk.data.date.getFullYear();
  if (!acc[year]) {
    acc[year] = [];
  }
  acc[year].push(talk);
  return acc;
}, {} as Record<number, typeof sortedTalks>);

/**
 * Extracts and sorts years in descending order
 * 
 * Ensures year sections are displayed from most recent to oldest.
 */
const years = Object.keys(talksByYear)
  .map(Number)
  .sort((a, b) => b - a);

/**
 * Total count of all speaking engagements for statistics display
 */
const totalTalks = sortedTalks.length;

/**
 * Count of conference talks specifically for statistics display
 * 
 * Highlights conference speaking experience as a key metric.
 */
const conferenceCount = sortedTalks.filter(t => t.data.type === 'conference').length;
---

<BaseLayout>
  <SEO 
    slot="head"
    title={pagesConfig.speaking.title}
    description={pagesConfig.speaking.description}
    type="website"
  />

  <main class="page-container">
    <header class="page-header">
      <h1 class="page-title">{pagesConfig.speaking.heading}</h1>
      <p class="page-intro">
        {pagesConfig.speaking.intro}
      </p>
      <PageStats text={`${totalTalks} talks Â· ${conferenceCount} conferences`} />
    </header>

    {years.length > 0 ? (
      <div class="talks-by-year">
        {years.map((year) => (
          <section class="year-section">
            <h2 class="year-heading">{year}</h2>
            <div class="talks-list">
              {talksByYear[year].map((talk) => (
                <TalkCard
                  title={talk.data.title}
                  description={talk.data.description}
                  event={talk.data.event}
                  eventUrl={talk.data.eventUrl}
                  date={talk.data.date}
                  location={talk.data.location}
                  type={talk.data.type}
                  slides={talk.data.slides}
                  video={talk.data.video}
                  duration={talk.data.duration}
                  topics={talk.data.topics}
                  featured={talk.data.featured}
                />
              ))}
            </div>
          </section>
        ))}
      </div>
    ) : (
      <p class="empty-state">No speaking engagements yet.</p>
    )}
  </main>

  <style>
    .talks-by-year {
      display: flex;
      flex-direction: column;
      gap: 3rem;
    }

    .year-section {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .year-heading {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--color-text);
      padding-bottom: 0.75rem;
      border-bottom: 2px solid var(--color-border);
      margin: 0;
    }

    .talks-list {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    @media (max-width: 768px) {
      .year-heading {
        font-size: 1.25rem;
      }
    }
  </style>
</BaseLayout>
